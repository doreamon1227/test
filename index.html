<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>施工驗收照片產生器（單檔 / 支援中文PDF）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    input, select, textarea { font-size: 16px; }
    .thumb { aspect-ratio: 4/3; object-fit: cover; background:#f8fafc; }
    /* PDF 內容容器寬度對齊 A4（pt: 595x842; 轉px依密度；使用相對寬度即可） */
    #pdfRoot { width: 800px; margin: 0 auto; }
    .page { page-break-after: always; padding: 24px; background: #fff; }
    .page:last-child { page-break-after: auto; }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap: 8px 12px; }
    .kv b { text-align:right; }
    .sig-box { border: 2px dashed #999; padding: 40px; height: 160px; display:flex; align-items:center; font-size: 20px; }
    .caption { font-size: 14px; color: #555; }
    .meta { font-size: 13px; color:#333; }
    .title { font-size: 22px; font-weight: 700; margin-bottom: 12px; }
    .section-title { font-size: 18px; font-weight: 600; margin: 10px 0; }
    .imgbox { width: 100%; max-height: 420px; overflow: hidden; border:1px solid #eee; border-radius: 10px; }
    .imgbox img { width: 100%; height: auto; display:block; }
    .break { page-break-before: always; }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-5xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="space-y-1">
      <h1 class="text-2xl font-bold">施工前/中/後 驗收資料產生器</h1>
      <p class="text-sm text-slate-500">手機上傳照片 → 填寫欄位 → 匯出 PDF（支援中文）/ TSV</p>
    </header>

    <!-- 基本欄位 -->
    <section class="bg-white rounded-2xl shadow-sm border p-4 sm:p-6">
      <div class="grid md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm font-semibold">工程類型：</span>
          <input id="etype" placeholder="例：機水電工程" class="w-full mt-1 px-3 py-2 rounded-xl border" />
        </label>
        <label class="block">
          <span class="text-sm font-semibold">施工階段：</span>
          <input id="phase" placeholder="例：前/中/後" class="w-full mt-1 px-3 py-2 rounded-xl border" />
        </label>
        <label class="block">
          <span class="text-sm font-semibold">施工區域：</span>
          <input id="area" placeholder="例：5樓廊道" class="w-full mt-1 px-3 py-2 rounded-xl border" />
        </label>
        <label class="block">
          <span class="text-sm font-semibold">承攬單位：</span>
          <input id="contractor" placeholder="例：彤甯企業社" class="w-full mt-1 px-3 py-2 rounded-xl border" />
        </label>
      </div>
    </section>

    <!-- 上傳照片 -->
    <section class="bg-white rounded-2xl shadow-sm border">
      <div class="p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-3">上傳照片</h2>
        <input id="file" type="file" accept="image/*" multiple class="sr-only">
        <label for="file" class="block border-2 border-dashed rounded-2xl p-6 text-center cursor-pointer hover:bg-slate-50">
          <div class="text-slate-600">點擊選擇照片（可多張）；系統會自動讀取 EXIF 日期/時間（若有）</div>
        </label>
      </div>
      <div id="list" class="p-4 sm:p-6 pt-0 grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <div class="flex gap-2">
      <button id="btn-tsv" class="px-3 py-2 rounded-xl bg-white border shadow-sm hover:bg-slate-50 disabled:opacity-40">匯出 TSV</button>
      <button id="btn-pdf" class="px-3 py-2 rounded-xl bg-blue-600 text-white shadow hover:bg-blue-700 disabled:opacity-40">產生 PDF</button>
    </div>

    <p class="text-xs text-slate-500">注意：本版使用 <b>html2pdf</b> 以畫面轉 PDF，能 100% 正確顯示中文，不需額外字型。</p>
  </div>

  <!-- 這是 PDF 專用的隱藏容器（會在匯出前動態填入內容） -->
  <div id="pdfRoot" class="hidden"></div>

  <!-- 套件：exifr + html2pdf（含 html2canvas + jsPDF） -->
  <script src="https://unpkg.com/exifr/dist/lite.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    const els = {
      etype: document.getElementById('etype'),
      phase: document.getElementById('phase'),
      area: document.getElementById('area'),
      contractor: document.getElementById('contractor'),
      file: document.getElementById('file'),
      list: document.getElementById('list'),
      pdfRoot: document.getElementById('pdfRoot'),
      btnPDF: document.getElementById('btn-pdf'),
      btnTSV: document.getElementById('btn-tsv'),
    };

    const state = { records: [] };

    function pad(n){return String(n).padStart(2,'0')}
    function formatDateTime(dt){
      const d = new Date(dt);
      const date = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const time = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      return { date, time, full: `${date} ${time}` };
    }
    function fileToDataURL(file){
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload=()=>res(r.result);
        r.onerror=rej;
        r.readAsDataURL(file);
      });
    }

    // 讀取檔案與 EXIF
    els.file.addEventListener('change', async e=>{
      const files = Array.from(e.target.files||[]);
      for(const f of files){
        try{
          const [exif, dataurl] = await Promise.all([
            exifr.parse(f).catch(()=>null),
            fileToDataURL(f),
          ]);
          const taken = exif?.DateTimeOriginal || exif?.CreateDate || new Date(f.lastModified);
          const { date, time } = formatDateTime(taken);
          state.records.push({
            id: Date.now()+'_'+Math.random().toString(36).slice(2),
            file: f,
            dataurl,
            desc: '',
            exifDate: date,
            exifTime: time,
          });
        }catch(err){ console.error('讀取失敗', err); }
      }
      render();
      e.target.value='';
    });

    function render(){
      els.btnPDF.disabled = els.btnTSV.disabled = state.records.length===0;
      els.list.innerHTML = state.records.map((r,i)=>`
        <div class="rounded-2xl border overflow-hidden bg-white">
          <img src="${r.dataurl}" alt="preview" class="w-full thumb" />
          <div class="p-3 space-y-2">
            <input placeholder="照片說明" value="${escapeHtml(r.desc)}"
                   oninput="updateDesc('${r.id}', this.value)"
                   class="border w-full p-2 rounded" />
            <div class="text-xs text-slate-600">EXIF 日期：${r.exifDate || '—'}　EXIF 時間：${r.exifTime || '—'}</div>
          </div>
        </div>
      `).join('');
    }
    window.updateDesc = (id, val)=>{
      state.records = state.records.map(r => r.id===id ? {...r, desc: val} : r);
    }
    function escapeHtml(s=''){ return s.replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // 匯出 TSV
    els.btnTSV.addEventListener('click', ()=>{
      if(!state.records.length) return;
      const header = ['工程類型','施工階段','施工區域','承攬單位','檔名','照片說明','EXIF 日期','EXIF 時間'];
      const rows = state.records.map(r => [
        els.etype.value, els.phase.value, els.area.value, els.contractor.value,
        r.file?.name || '', (r.desc||'').replace(/\t/g,' ').replace(/\n/g,' ').trim(),
        r.exifDate || '', r.exifTime || ''
      ]);
      const tsv = [header.join('\t'), ...rows.map(a=>a.join('\t'))].join('\n');
      const blob = new Blob([tsv], {type:'text/tab-separated-values;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='photo_log.tsv'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    });

    // 產生 PDF（以 DOM 轉影像，確保中文顯示）
    els.btnPDF.addEventListener('click', async ()=>{
      if(!state.records.length) return;

      // 準備 pdf DOM
      const root = els.pdfRoot;
      root.innerHTML = '';
      root.classList.remove('hidden');

      // 封面/基本資訊
      const now = formatDateTime(new Date()).full;
      const cover = document.createElement('section');
      cover.className = 'page';
      cover.innerHTML = `
        <div class="title">施工驗收照片紀錄</div>
        <div class="kv meta">
          <b>工程類型：</b><div>${escapeHtml(els.etype.value)}</div>
          <b>施工階段：</b><div>${escapeHtml(els.phase.value)}</div>
          <b>施工區域：</b><div>${escapeHtml(els.area.value)}</div>
          <b>承攬單位：</b><div>${escapeHtml(els.contractor.value)}</div>
          <b>產生時間：</b><div>${now}</div>
        </div>
        <div class="section-title">總照片數：${state.records.length} 張</div>
      `;
      root.appendChild(cover);

      // 每張照片一頁
      for(const [idx, r] of state.records.entries()){
        const page = document.createElement('section');
        page.className = 'page';
        page.innerHTML = `
          <div class="section-title">照片 ${idx+1}</div>
          <div class="imgbox"><img src="${r.dataurl}" /></div>
          <div class="kv meta" style="margin-top:12px">
            <b>照片說明：</b><div>${escapeHtml(r.desc || '')}</div>
            <b>EXIF 日期：</b><div>${r.exifDate || '—'}</div>
            <b>EXIF 時間：</b><div>${r.exifTime || '—'}</div>
            <b>檔名：</b><div>${escapeHtml(r.file?.name || '')}</div>
          </div>
        `;
        root.appendChild(page);
      }

      // 簽章頁
      const sign = document.createElement('section');
      sign.className = 'page';
      sign.innerHTML = `
        <div class="title">簽章</div>
        <div class="sig-box">監造單位：＿＿＿＿＿＿</div>
      `;
      root.appendChild(sign);

      // 轉 PDF
      const opt = {
        margin:       10,
        filename:     'report.pdf',
        image:        { type: 'jpeg', quality: 0.95 },
        html2canvas:  { scale: 2, useCORS: true },
        jsPDF:        { unit: 'pt', format: 'a4', orientation: 'portrait' },
        pagebreak:    { mode: ['css', 'legacy'] }
      };
      await html2pdf().from(root).set(opt).save();

      // 清空隱藏容器（避免佔 DOM）
      root.innerHTML = '';
      root.classList.add('hidden');
    });
  </script>
</body>
</html>
