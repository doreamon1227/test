<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>施工照片 PDF 匯出（依方向 / 指定欄位順序）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* A4 pixel sizes at ~96dpi */
    :root {
      --P-W: 794px; --P-H: 1123px;  /* portrait */
      --L-W: 1123px; --L-H: 794px;  /* landscape */
      /* Image boxes: portrait 9x14.5cm (WxH), landscape 13.5x8cm (WxH) */
      --PBW: 340px; --PBH: 548px;   /* 9cm≈340px, 14.5cm≈548px */
      --LBW: 510px; --LBH: 303px;   /* 13.5cm≈510px, 8cm≈303px */
    }
    body { background:#f8fafc; }
    input, textarea { font-size:16px; }
    /* Screen preview */
    .thumb { aspect-ratio: 4/3; object-fit: cover; background:#f1f5f9; }
    /* Offscreen PDF roots */
    #pdfRootP, #pdfRootL { position: fixed; left:-12000px; top:0; background:#fff; }
    .pageP { width: var(--P-W); height: var(--P-H); padding: 20px; box-sizing: border-box; display:grid; grid-template-rows: 1fr 1fr; gap:18px; page-break-after: always; }
    .pageL { width: var(--L-W); height: var(--L-H); padding: 20px; box-sizing: border-box; display:grid; grid-template-columns: 1fr 1fr; gap:18px; page-break-after: always; }
    .pageP:last-child, .pageL:last-child { page-break-after: auto; }
    .card { border:1.5px solid #111; border-radius:10px; padding:10px; display:grid; gap:6px; grid-template-rows:auto auto auto auto auto auto auto; }
    .label { font-weight:600; font-size:14px; color:#111; }
    .kv-value { font-size:13px; color:#111; white-space:pre-wrap; }
    .imgboxP, .imgboxL { border:1px solid #e5e7eb; border-radius:8px; background:#fff; display:flex; align-items:center; justify-content:center; }
    .imgboxP { width: var(--PBW); height: var(--PBH); margin: 0 auto; }
    .imgboxL { width: var(--LBW); height: var(--LBH); margin: 0 auto; }
    .imgboxP img, .imgboxL img { max-width:100%; max-height:100%; width:auto; height:auto; object-fit: contain; background:#fff; }
    .hide { display:none; }
  </style>
</head>
<body>
  <div class="max-w-4xl mx-auto p-4 space-y-4">
    <header>
      <h1 class="text-xl font-bold">施工照片 PDF 匯出</h1>
      <p class="text-sm text-slate-600">欄位順序：施工說明（可輸入）→ 施工單位 → 施工區域（可輸入）→ 施工階段（可輸入）→ 施工時間（EXIF / 檔案時間）。直照輸出 A4 直向；橫照輸出 A4 橫向；每頁兩張。</p>
    </header>

    <!-- 施工單位（全域欄位） -->
    <section class="bg-white rounded-2xl shadow-sm border p-4 sm:p-6">
      <label class="block">
        <span class="text-sm font-semibold">施工單位：</span>
        <input id="contractor" placeholder="例：彤甯企業社" class="w-full mt-1 px-3 py-2 rounded-xl border" />
      </label>
    </section>

    <!-- 上傳 -->
    <section class="bg-white rounded-2xl shadow-sm border">
      <div class="p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-3">上傳照片</h2>
        <input id="file" type="file" accept="image/*" multiple class="sr-only">
        <label for="file" class="block border-2 border-dashed rounded-2xl p-6 text-center cursor-pointer hover:bg-slate-50">
          <div class="text-slate-600">點擊選擇照片（可多張）；自動讀取 EXIF 日期/時間（若有）。</div>
        </label>
      </div>
      <div id="list" class="p-4 sm:p-6 pt-0 grid md:grid-cols-2 gap-4"></div>
    </section>

    <div class="flex flex-wrap gap-2">
      <button id="btn-pdf-portrait" class="px-3 py-2 rounded-xl bg-blue-600 text-white shadow hover:bg-blue-700 disabled:opacity-40">產生 PDF（直照 → A4 直向）</button>
      <button id="btn-pdf-landscape" class="px-3 py-2 rounded-xl bg-indigo-600 text-white shadow hover:bg-indigo-700 disabled:opacity-40">產生 PDF（橫照 → A4 橫向）</button>
      <button id="btn-pdf-both" class="px-3 py-2 rounded-xl bg-emerald-600 text-white shadow hover:bg-emerald-700 disabled:opacity-40">一次產生兩份 PDF</button>
    </div>
  </div>

  <!-- Offscreen roots -->
  <div id="pdfRootP" class="hide"></div>
  <div id="pdfRootL" class="hide"></div>

  <script src="https://unpkg.com/exifr/dist/lite.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    const els = {
      contractor: document.getElementById('contractor'),
      file: document.getElementById('file'),
      list: document.getElementById('list'),
      rootP: document.getElementById('pdfRootP'),
      rootL: document.getElementById('pdfRootL'),
      btnP: document.getElementById('btn-pdf-portrait'),
      btnL: document.getElementById('btn-pdf-landscape'),
      btnB: document.getElementById('btn-pdf-both'),
    };

    const state = { records: [] };

    function pad(n){return String(n).padStart(2,'0')}
    function formatDateTime(dt){
      const d = new Date(dt);
      const date = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const time = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      return { date, time, full: `${date} ${time}` };
    }
    function fileToDataURL(file){
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload=()=>res(r.result);
        r.onerror=rej;
        r.readAsDataURL(file);
      });
    }
    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // 讀檔 + EXIF + 判斷方向
    els.file.addEventListener('change', async e=>{
      const files = Array.from(e.target.files||[]);
      for(const f of files){
        try{
          const [exif, dataurl] = await Promise.all([
            exifr.parse(f).catch(()=>null),
            fileToDataURL(f),
          ]);
          const img = new Image(); img.src = dataurl;
          await new Promise(r=>{img.onload=r; img.onerror=r;});
          const taken = exif?.DateTimeOriginal || exif?.CreateDate || new Date(f.lastModified);
          const { date, time } = formatDateTime(taken);
          state.records.push({
            id: Date.now()+'_'+Math.random().toString(36).slice(2),
            file: f, dataurl,
            desc:'', area:'', phase:'',
            exifDate: date, exifTime: time,
            orient: (img.naturalHeight||0) >= (img.naturalWidth||0) ? 'portrait' : 'landscape'
          });
        }catch(err){ console.error('讀取失敗', err); }
      }
      render();
      e.target.value='';
    });

    function render(){
      els.list.innerHTML = state.records.map(r=>`
        <div class="border rounded-xl bg-white p-3">
          <img src="${r.dataurl}" alt="preview" class="thumb w-full mb-2"/>
          <div class="label">施工說明（可輸入）</div>
          <textarea rows="2" placeholder="請輸入說明…" oninput="updateRec('${r.id}','desc', this.value)" class="border w-full p-2 rounded">${escapeHtml(r.desc)}</textarea>
          <div class="label mt-2">施工單位</div>
          <div class="kv-value">${escapeHtml(els.contractor.value || '')}</div>
          <div class="label mt-2">施工區域（可輸入）</div>
          <input placeholder="例：5樓廊道" value="${escapeHtml(r.area)}" oninput="updateRec('${r.id}','area', this.value)" class="border w-full p-2 rounded"/>
          <div class="label mt-2">施工階段（可輸入）</div>
          <input placeholder="例：前/中/後" value="${escapeHtml(r.phase)}" oninput="updateRec('${r.id}','phase', this.value)" class="border w-full p-2 rounded"/>
          <div class="label mt-2">施工時間（自動抓 EXIF 日期時間；無 EXIF 就用檔案時間）</div>
          <div class="kv-value">${r.exifDate || '—'} ${r.exifTime || ''}</div>
        </div>
      `).join('');
      const hasP = state.records.some(r=>r.orient==='portrait');
      const hasL = state.records.some(r=>r.orient==='landscape');
      els.btnP.disabled = !hasP;
      els.btnL.disabled = !hasL;
      els.btnB.disabled = !(hasP || hasL);
    }
    window.updateRec = (id, key, val)=>{
      state.records = state.records.map(r => r.id===id ? {...r, [key]: val} : r);
    }

    async function buildAndSavePDF(orient){
      const root = orient==='portrait' ? els.rootP : els.rootL;
      root.innerHTML = '';
      const target = state.records.filter(r=>r.orient===orient);
      if(!target.length) return;

      if(orient==='portrait'){ // 2 rows
        for(let i=0;i<target.length;i+=2){
          const page = document.createElement('section');
          page.className = 'pageP';
          for(const r of target.slice(i,i+2)){
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
              <div class="label">施工照片</div>
              <div class="imgboxP"><img src="${r.dataurl}" alt="img"/></div>
              <div class="label">施工說明（可輸入）</div>
              <div class="kv-value">${escapeHtml(r.desc||'')}</div>
              <div class="label">施工單位</div>
              <div class="kv-value">${escapeHtml(els.contractor.value||'')}</div>
              <div class="label">施工區域（可輸入）</div>
              <div class="kv-value">${escapeHtml(r.area||'')}</div>
              <div class="label">施工階段（可輸入）</div>
              <div class="kv-value">${escapeHtml(r.phase||'')}</div>
              <div class="label">施工時間（自動抓 EXIF 日期時間；無 EXIF 就用檔案時間）</div>
              <div class="kv-value">${r.exifDate || '—'} ${r.exifTime || ''}</div>
            `;
            page.appendChild(card);
          }
          root.appendChild(page);
        }
      } else { // landscape: 2 columns
        for(let i=0;i<target.length;i+=2){
          const page = document.createElement('section');
          page.className = 'pageL';
          for(const r of target.slice(i,i+2)){
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
              <div class="label">施工照片</div>
              <div class="imgboxL"><img src="${r.dataurl}" alt="img"/></div>
              <div class="label">施工說明（可輸入）</div>
              <div class="kv-value">${escapeHtml(r.desc||'')}</div>
              <div class="label">施工單位</div>
              <div class="kv-value">${escapeHtml(els.contractor.value||'')}</div>
              <div class="label">施工區域（可輸入）</div>
              <div class="kv-value">${escapeHtml(r.area||'')}</div>
              <div class="label">施工階段（可輸入）</div>
              <div class="kv-value">${escapeHtml(r.phase||'')}</div>
              <div class="label">施工時間（自動抓 EXIF 日期時間；無 EXIF 就用檔案時間）</div>
              <div class="kv-value">${r.exifDate || '—'} ${r.exifTime || ''}</div>
            `;
            page.appendChild(card);
          }
          root.appendChild(page);
        }
      }

      const opt = {
        margin: [0,0,0,0],
        filename: orient==='portrait' ? '直照_A4直向.pdf' : '橫照_A4橫向.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
        jsPDF: { unit: 'pt', format: 'a4', orientation: orient==='portrait' ? 'portrait' : 'landscape' },
        pagebreak: { mode: ['css'] }
      };
      await html2pdf().from(root).set(opt).save();
      root.innerHTML = '';
    }

    els.btnP.addEventListener('click', ()=>buildAndSavePDF('portrait'));
    els.btnL.addEventListener('click', ()=>buildAndSavePDF('landscape'));
    els.btnB.addEventListener('click', async ()=>{ await buildAndSavePDF('portrait'); await buildAndSavePDF('landscape'); });
  </script>
</body>
</html>
