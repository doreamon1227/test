<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>施工前/中/後 驗收資料產生器（單一HTML）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* iOS input reset tweaks */
    input, select, textarea { font-size: 16px; }
    .thumb { aspect-ratio: 4/3; object-fit: cover; }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-6xl mx-auto p-4 sm:p-6 space-y-4">
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold">施工前/中/後 驗收資料產生器</h1>
        <p class="text-sm text-slate-500">手機上傳照片 → 填寫說明與位置 → 一鍵匯出 PDF 與 TSV（Excel 可貼上）</p>
      </div>
      <div class="flex gap-2">
        <button id="btn-tsv" class="px-3 py-2 rounded-xl bg-white border shadow-sm hover:bg-slate-50 disabled:opacity-40">匯出 TSV</button>
        <button id="btn-pdf" class="px-3 py-2 rounded-xl bg-blue-600 text-white shadow hover:bg-blue-700 disabled:opacity-40">產生 PDF</button>
      </div>
    </header>

    <!-- 基本資料 -->
    <section class="bg-white rounded-2xl shadow-sm border p-4 sm:p-6">
      <h2 class="text-lg font-semibold mb-3">基本資料</h2>
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-3">
        <label class="block">
          <span class="text-sm text-slate-600">專案名稱</span>
          <input id="project" class="w-full mt-1 px-3 py-2 rounded-xl border" placeholder="例：杉原灣文旅整建案" />
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">工地/區域</span>
          <input id="site" class="w-full mt-1 px-3 py-2 rounded-xl border" placeholder="例：B1機房 / 5F走道" />
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">承攬/工班</span>
          <input id="contractor" class="w-full mt-1 px-3 py-2 rounded-xl border" placeholder="例：駿龍企業社" />
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">監造/帶驗人</span>
          <input id="supervisor" class="w-full mt-1 px-3 py-2 rounded-xl border" placeholder="例：張三（監造）" />
        </label>
      </div>
      <div class="flex flex-wrap gap-4 items-center mt-3 text-sm">
        <label class="inline-flex items-center gap-2"><input type="checkbox" id="groupByPhase" checked> 依施工階段分組</label>
        <label class="inline-flex items-center gap-2"><input type="checkbox" id="includeGps" checked> PDF 顯示 GPS（若有 EXIF）</label>
      </div>
    </section>

    <!-- 上傳區域 -->
    <section class="bg-white rounded-2xl shadow-sm border">
      <div class="p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-3">上傳照片</h2>
        <div id="drop" class="border-2 border-dashed rounded-2xl p-6 text-center cursor-pointer hover:bg-slate-50">
          <input id="file" type="file" accept="image/*" multiple class="hidden" capture="environment" />
          <div class="text-slate-500">點擊或拖曳上傳（可多張；自動讀取 EXIF 拍攝時間/GPS）</div>
          <div class="text-xs mt-1 text-slate-400">建議：施工前/中/後各補幾張關鍵節點照片</div>
        </div>
      </div>
      <div id="list" class="p-4 sm:p-6 pt-0"></div>
    </section>

    <footer class="text-xs text-slate-500">小提示：若相機停用定位或圖片無 EXIF GPS，PDF 將不顯示座標。拍攝時間也可手動調整。</footer>
  </div>

  <!-- 依賴套件：exifr + jsPDF -->
  <script src="https://unpkg.com/exifr/dist/lite.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const PHASES = [
      { value: 'before', label: '施工前' },
      { value: 'during', label: '施工中' },
      { value: 'after',  label: '施工後' },
    ];
    const TRADES = ['土木/結構','建築/裝修','水電/弱電','空調/消防','景觀/外構','其他'];

    const els = {
      project: document.getElementById('project'),
      site: document.getElementById('site'),
      contractor: document.getElementById('contractor'),
      supervisor: document.getElementById('supervisor'),
      groupByPhase: document.getElementById('groupByPhase'),
      includeGps: document.getElementById('includeGps'),
      file: document.getElementById('file'),
      drop: document.getElementById('drop'),
      list: document.getElementById('list'),
      btnPDF: document.getElementById('btn-pdf'),
      btnTSV: document.getElementById('btn-tsv'),
    };

    const state = { records: [] };

    function formatDate(dt){
      if(!dt) return '';
      try{
        const d = (typeof dt === 'string') ? new Date(dt) : dt;
        const yy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        const ss = String(d.getSeconds()).padStart(2,'0');
        return `${yy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
      }catch{ return ''; }
    }
    function toInputDatetimeLocal(dt){
      try{ return new Date(dt).toISOString().slice(0,16) }catch{ return '' }
    }
    function degToDMS(deg,isLat){
      if (deg==null || isNaN(deg)) return '';
      const dir = isLat ? (deg>=0?'N':'S') : (deg>=0?'E':'W');
      const abs = Math.abs(deg);
      const d = Math.floor(abs);
      const minFloat = (abs - d) * 60;
      const m = Math.floor(minFloat);
      const s = Math.round((minFloat - m) * 60);
      return `${d}°${m}'${s}" ${dir}`;
    }
    function fileToDataURL(file){
      return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    }

    async function handleFiles(files){
      const arr = Array.from(files||[]);
      for(const file of arr){
        try{
          const [exif, dataurl] = await Promise.all([
            exifr.parse(file).catch(()=>null),
            fileToDataURL(file),
          ]);
          const takenAt = exif?.DateTimeOriginal || exif?.CreateDate || new Date(file.lastModified);
          const lat = exif?.latitude ?? exif?.GPSLatitude ?? null;
          const lng = exif?.longitude ?? exif?.GPSLongitude ?? null;
          state.records.push({
            id: `${Date.now()}_${Math.random().toString(36).slice(2)}`,
            file, dataurl,
            takenAt, lat, lng,
            area:'', trade:'', desc:'', phase:'during',
          });
        }catch(e){ console.error('read exif failed', e); }
      }
      render();
    }

    // Drag & click upload
    els.drop.addEventListener('click', ()=> els.file.click());
    els.file.addEventListener('change', (e)=>{ handleFiles(e.target.files); e.target.value=''; });
    ;['dragenter','dragover'].forEach(ev=>{
      els.drop.addEventListener(ev, (e)=>{ e.preventDefault(); els.drop.classList.add('bg-slate-50'); });
    });
    ;['dragleave','drop'].forEach(ev=>{
      els.drop.addEventListener(ev, (e)=>{ e.preventDefault(); els.drop.classList.remove('bg-slate-50'); });
    });
    els.drop.addEventListener('drop', (e)=>{ handleFiles(e.dataTransfer.files); });

    function update(id, patch){
      state.records = state.records.map(r=> r.id===id?({...r,...patch}):r);
    }
    function removeRec(id){ state.records = state.records.filter(r=>r.id!==id); render(); }

    function render(){
      els.btnPDF.disabled = els.btnTSV.disabled = state.records.length===0;

      const group = els.groupByPhase.checked;
      let content = '';
      const sections = group ? ['before','during','after'] : ['all'];
      const sectionTitle = (key)=> ({before:'施工前', during:'施工中', after:'施工後', all:'全部照片'})[key]||key;
      const listBy = (key)=> key==='all'? state.records : state.records.filter(r=>r.phase===key);

      for(const sec of sections){
        const rows = listBy(sec);
        content += `<div class="mb-4">`
          + `<div class="flex items-center justify-between mb-2"><h3 class="font-semibold">${sectionTitle(sec)} <span class="text-xs text-slate-500">(${rows.length} 張)</span></h3></div>`
          + `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">`
          + rows.map(r=> card(r)).join('')
          + `</div></div>`;
      }
      els.list.innerHTML = content || '<div class="text-sm text-slate-500">尚未上傳照片</div>';

      // bind events
      for(const r of state.records){
        const base = `rec-${r.id}`;
        const dt = document.getElementById(base+'-dt'); if(dt){ dt.addEventListener('change', e=> update(r.id,{ takenAt:new Date(e.target.value) })); }
        const area = document.getElementById(base+'-area'); if(area){ area.addEventListener('input', e=> update(r.id,{ area:e.target.value })); }
        const desc = document.getElementById(base+'-desc'); if(desc){ desc.addEventListener('input', e=> update(r.id,{ desc:e.target.value })); }
        const phase = document.getElementById(base+'-phase'); if(phase){ phase.addEventListener('change', e=> update(r.id,{ phase:e.target.value })); }
        const trade = document.getElementById(base+'-trade'); if(trade){ trade.addEventListener('change', e=> update(r.id,{ trade:e.target.value })); }
        const del = document.getElementById(base+'-del'); if(del){ del.addEventListener('click', ()=> removeRec(r.id)); }
      }
    }

    function card(r){
      return `
      <div class="rounded-2xl border overflow-hidden bg-white">
        <img src="${r.dataurl}" alt="preview" class="w-full thumb" />
        <div class="p-3 space-y-2">
          <div class="grid grid-cols-2 gap-2">
            <label class="block">
              <span class="text-xs text-slate-600">拍攝時間</span>
              <input id="rec-${r.id}-dt" type="datetime-local" value="${toInputDatetimeLocal(r.takenAt)}" class="w-full mt-1 px-2 py-2 rounded-xl border" />
            </label>
            <label class="block">
              <span class="text-xs text-slate-600">工種</span>
              <select id="rec-${r.id}-trade" class="w-full mt-1 px-2 py-2 rounded-xl border">${TRADES.map(t=>`<option ${r.trade===t?'selected':''}>${t}</option>`).join('')}</select>
            </label>
            <label class="block">
              <span class="text-xs text-slate-600">位置/區域</span>
              <input id="rec-${r.id}-area" value="${escapeHtml(r.area)}" placeholder="例：B1 機房東側、501 天花內" class="w-full mt-1 px-2 py-2 rounded-xl border" />
            </label>
            <label class="block">
              <span class="text-xs text-slate-600">施工階段</span>
              <select id="rec-${r.id}-phase" class="w-full mt-1 px-2 py-2 rounded-xl border">${PHASES.map(p=>`<option value="${p.value}" ${r.phase===p.value?'selected':''}>${p.label}</option>`).join('')}</select>
            </label>
            <label class="block col-span-2">
              <span class="text-xs text-slate-600">照片說明</span>
              <textarea id="rec-${r.id}-desc" rows="3" class="w-full mt-1 px-2 py-2 rounded-xl border" placeholder="例：拆除完成，既有管線清點，待新配管定位。">${escapeHtml(r.desc)}</textarea>
            </label>
          </div>
          <div class="flex items-center justify-between text-xs text-slate-500">
            <div>${(r.lat!=null && r.lng!=null) ? `GPS ${degToDMS(r.lat,true)} / ${degToDMS(r.lng,false)}` : '（無 EXIF GPS）'}</div>
            <button id="rec-${r.id}-del" class="px-2 py-1 rounded-lg border hover:bg-red-50">刪除</button>
          </div>
        </div>
      </div>`;
    }

    function escapeHtml(s=''){ return s.replace(/[&<>\"']/g, m=>({\"&\":\"&amp;\",\"<\":\"&lt;\",\">\":\"&gt;\",\"\\\"\":\"&quot;\",\"'\":\"&#39;\"}[m])); }

    // Export TSV
    els.btnTSV.addEventListener('click', ()=>{
      const header = ['Project','Site','Contractor','Supervisor','Phase','Area','Trade','Description','TakenAt','Latitude','Longitude','FileName'];
      const rows = state.records.map(r=>[
        els.project.value, els.site.value, els.contractor.value, els.supervisor.value,
        (PHASES.find(p=>p.value===r.phase)?.label || r.phase),
        (r.area||'').replaceAll('\\t',' ').replaceAll('\\n',' ').trim(),
        r.trade||'',
        (r.desc||'').replaceAll('\\t',' ').replaceAll('\\n',' ').trim(),
        formatDate(r.takenAt), r.lat??'', r.lng??'', r.file?.name||''
      ]);
      const tsv = [header.join('\\t'), ...rows.map(a=>a.join('\\t'))].join('\\n');
      const blob = new Blob([tsv], {type:'text/tab-separated-values;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      download(url, `${els.project.value||'Acceptance'}_photo_log.tsv`);
    });

    // Export PDF
    els.btnPDF.addEventListener('click', async ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const margin = 40;
      let y = margin;

      function text(x,y,str,size=10){ doc.setFontSize(size); doc.text(str, x,y); }
      function headerLine(title){
        doc.setFontSize(16); doc.text(title, margin, y); y+=10;
        doc.setFontSize(10);
        const meta = `專案：${els.project.value||''} | 工地：${els.site.value||''} | 承攬：${els.contractor.value||''} | 監造/帶驗：${els.supervisor.value||''}`;
        doc.text(meta, margin, y+12); y+=28;
      }
      async function photoCard(r, idx){
        const cardH = 210; const cardW = 515;
        if (y + cardH > doc.internal.pageSize.getHeight() - margin){ doc.addPage(); y = margin; }
        doc.setLineWidth(0.5); doc.rect(margin, y, cardW, cardH);
        try{ doc.addImage(r.dataurl, 'JPEG', margin+10, y+10, 200, 150); }catch{}
        const x = margin+10+210; let ty = y+18;
        text(x, ty, `${idx}. ${(PHASES.find(p=>p.value===r.phase)?.label||r.phase)}`, 11); ty+=18;
        const wrap = doc.splitTextToSize(`說明：${r.desc||''}`, 280); doc.text(wrap, x, ty); ty += 12 + (wrap.length-1)*12;
        text(x, ty, `位置/區域：${r.area||''}`); ty+=14;
        text(x, ty, `工種：${r.trade||''}`); ty+=14;
        text(x, ty, `拍攝時間：${formatDate(r.takenAt)}`); ty+=14;
        if (els.includeGps.checked && (r.lat!=null || r.lng!=null)) text(x, ty, `GPS：${degToDMS(r.lat,true)} / ${degToDMS(r.lng,false)}`);
        doc.setFontSize(9); doc.text(`檔名：${r.file?.name||''}`, margin+10, y+cardH-10);
        y += cardH + 12;
      }

      // Cover
      doc.setFontSize(20); doc.text('施工驗收照片紀錄', margin, y); y+=24;
      text(margin, y, `專案：${els.project.value||''}`, 12); y+=16;
      text(margin, y, `工地：${els.site.value||''}`, 12); y+=16;
      text(margin, y, `承攬：${els.contractor.value||''}`, 12); y+=16;
      text(margin, y, `監造/帶驗：${els.supervisor.value||''}`, 12); y+=16;
      text(margin, y, `產生日期：${formatDate(new Date())}`, 12); y+=24;
      doc.addPage(); y = margin;

      const group = els.groupByPhase.checked;
      if(group){
        for(const sec of ['before','during','after']){
          const list = state.records.filter(r=>r.phase===sec);
          headerLine(`${(PHASES.find(p=>p.value===sec)?.label||sec)}（${list.length}張）`);
          let i=1; for(const r of list){ await photoCard(r, i++); }
        }
      }else{
        headerLine(`全部照片（${state.records.length}張）`);
        let i=1; for(const r of state.records){ await photoCard(r, i++); }
      }

      doc.save(`${els.project.value||'Acceptance'}_照片驗收紀錄.pdf`);
    });

    function download(url, filename){
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    // initial render
    render();
  </script>
</body>
</html>
